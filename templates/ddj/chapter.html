{% extends "base.html" %}

{% block title %}ç¬¬{{ chapter.chapter }}ç«  - é“å¾·ç»{% endblock %}

{% block page_title %}
<span class="navbar-text ms-3 d-none d-md-block">
    ç¬¬{{ chapter.chapter }}ç« 
</span>
{% endblock %}

{% block content %}
<div class="chapter-view container-fluid px-4">
    <!-- ç« èŠ‚å¯¼èˆª -->
    <nav aria-label="ç« èŠ‚å¯¼èˆª" class="chapter-nav mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('daodejing_index') }}">ç›®å½•</a></li>
            <li class="breadcrumb-item active">ç¬¬{{ chapter.chapter }}ç« </li>
        </ol>
    </nav>

    <!-- æ“ä½œæŒ‰é’®æ  -->
    <div class="action-bar mb-3 d-flex justify-content-between align-items-center">
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-primary" id="bookmarkBtn" title="æ”¶è—æœ¬ç« ">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2z"></path>
                </svg>
                <span class="ms-1">æ”¶è—</span>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="noteBtn" title="æ·»åŠ ç¬”è®°">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                <span class="ms-1">ç¬”è®°</span>
            </button>
            <button type="button" class="btn btn-outline-success" id="quoteBtn" title="ç”Ÿæˆå¼•ç”¨å¡ç‰‡">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <span class="ms-1">å¼•ç”¨å¡ç‰‡</span>
            </button>
        </div>
        <div class="chapter-id-badge">
            <span class="badge bg-secondary" id="chapterNum">ç¬¬{{ chapter.chapter }}ç« </span>
        </div>
    </div>

    <!-- æˆè¯­ç›¸å…³ -->
    <section class="idioms-section mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ğŸ“– ç›¸å…³æˆè¯­</h5>
            </div>
            <div class="card-body">
                <div id="idiomsContainer" class="idioms-container">
                    <span class="text-muted">åŠ è½½ä¸­...</span>
                </div>
            </div>
        </div>
    </section>

    <!-- åŸæ–‡å¡ç‰‡ -->
    <section class="original-section mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ç¬¬{{ chapter.chapter }}ç«  Â· åŸæ–‡</h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" data-copy-target="originalText"
                            title="å¤åˆ¶åŸæ–‡">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="original-text" id="originalText">
                    {{ chapter.original_annotated|safe }}
                </div>
            </div>
        </div>
    </section>

    <!-- ç°ä»£ç™½è¯è¯‘æ–‡ -->
    <section class="modern-section mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ç°ä»£ç™½è¯è¯‘æ–‡</h5>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-copy-target="translationText"
                        title="å¤åˆ¶è¯‘æ–‡">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                    </svg>
                </button>
            </div>
            <div class="card-body">
                <p class="modern-text mb-0" id="translationText">{{ chapter.modern_chinese }}</p>
            </div>
        </div>
    </section>

    <!-- å¤šç‰ˆæœ¬å¯¹ç…§ Tabs -->
    <section class="versions-section mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">å¤šç‰ˆæœ¬å¯¹ç…§</h5>
            </div>
            <div class="card-body p-0">
                <ul class="nav nav-tabs" id="versionTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#wangbi"
                                type="button">ç‹å¼¼æ³¨</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#heshanggong"
                                type="button">æ²³ä¸Šå…¬æ³¨</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#suzhe"
                                type="button">è‹è¾™æ³¨</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#wangfuzhi"
                                type="button">ç‹å¤«ä¹‹æ³¨</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#hanshan"
                                type="button">æ†¨å±±å¾·æ¸…æ³¨</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#lihanxu"
                                type="button">ææ¶µè™šæ³¨</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#huangyuanji"
                                type="button">é»„å…ƒå‰æ³¨</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#weiyuan"
                                type="button">é­æºæ³¨</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#postsilk"
                                type="button">å¸›ä¹¦å¼‚æ–‡</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#guodian"
                                type="button">éƒ­åº—å¼‚æ–‡</button>
                    </li>
                    <li class="nav-item ms-auto">
                        <a href="{{ url_for('compare_view', chapter_id=chapter.chapter) }}"
                           class="btn btn-sm btn-outline-primary mt-1">å…¨å±å¯¹ç…§</a>
                    </li>
                </ul>
                <div class="tab-content p-3">
                    <div class="tab-pane fade show active" id="wangbi">
                        <h6 class="text-muted mb-2">ç‹å¼¼æ³¨ï¼ˆé­æ™‹ï¼‰</h6>
                        <p class="note-text mb-0">{{ chapter.wangbi_note }}</p>
                    </div>
                    <div class="tab-pane fade" id="heshanggong">
                        <h6 class="text-muted mb-2">æ²³ä¸Šå…¬æ³¨ï¼ˆæ±‰ï¼‰</h6>
                        <p class="note-text mb-0">{{ chapter.heshanggong_note }}</p>
                    </div>
                    <div class="tab-pane fade" id="suzhe">
                        <h6 class="text-muted mb-2">è‹è¾™ã€Šè€å­è§£ã€‹ï¼ˆåŒ—å®‹ï¼‰</h6>
                        <p class="note-text mb-0">{% if chapter.suzhe_note %}{{ chapter.suzhe_note }}{% else %}æ­¤ç‰ˆæœ¬æš‚æœªæ”¶å½•{% endif %}</p>
                    </div>
                    <div class="tab-pane fade" id="wangfuzhi">
                        <h6 class="text-muted mb-2">ç‹å¤«ä¹‹ã€Šè€å­è¡ã€‹ï¼ˆæ˜æœ«æ¸…åˆï¼‰</h6>
                        <p class="note-text mb-0">{{ chapter.wangfuzhi_note }}</p>
                    </div>
                    <div class="tab-pane fade" id="hanshan">
                        <h6 class="text-muted mb-2">æ†¨å±±å¾·æ¸…ã€Šè€å­é“å¾·ç»è§£ã€‹ï¼ˆæ˜ï¼‰</h6>
                        <p class="note-text mb-0">{{ chapter.hanshandeqing_note }}</p>
                    </div>
                    <div class="tab-pane fade" id="lihanxu">
                        <h6 class="text-muted mb-2">ææ¶µè™šã€Šé“å¾·ç»æ³¨é‡Šã€‹ï¼ˆæ¸…ï¼‰</h6>
                        <p class="note-text mb-0">{% if chapter.lihanxu_note %}{{ chapter.lihanxu_note }}{% else %}æ­¤ç‰ˆæœ¬æš‚æœªæ”¶å½•{% endif %}</p>
                    </div>
                    <div class="tab-pane fade" id="huangyuanji">
                        <h6 class="text-muted mb-2">é»„å…ƒå‰ã€Šé“å¾·ç»çœŸä¹‰ã€‹ï¼ˆæ¸…ï¼‰</h6>
                        <p class="note-text mb-0">{% if chapter.huangyuanji_note %}{{ chapter.huangyuanji_note }}{% else %}æ­¤ç‰ˆæœ¬æš‚æœªæ”¶å½•{% endif %}</p>
                    </div>
                    <div class="tab-pane fade" id="weiyuan">
                        <h6 class="text-muted mb-2">é­æºã€Šè€å­æœ¬ä¹‰ã€‹ï¼ˆæ¸…ï¼‰</h6>
                        <p class="note-text mb-0">{% if chapter.weiyuan_note %}{{ chapter.weiyuan_note }}{% else %}æ­¤ç‰ˆæœ¬æš‚æœªæ”¶å½•{% endif %}</p>
                    </div>
                    <div class="tab-pane fade" id="postsilk">
                        <h6 class="text-muted mb-2">é©¬ç‹å †å¸›ä¹¦å¼‚æ–‡ï¼ˆè¥¿æ±‰ï¼‰</h6>
                        <div class="version-content mb-0">
                            {% if chapter.postsilk_text %}
                            <div class="version-original-text mb-3">
                                <p class="note-text mb-0 fst-italic">{{ chapter.postsilk_text }}</p>
                            </div>
                            {% endif %}
                            <div class="version-explanation">
                                <small class="text-muted">{{ chapter.postsilk_diff }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="guodian">
                        <h6 class="text-muted mb-2">éƒ­åº—æ¥šç®€å¼‚æ–‡ï¼ˆæˆ˜å›½ï¼‰</h6>
                        <div class="version-content mb-0">
                            {% if chapter.guodian_text %}
                            <div class="version-original-text mb-3">
                                <p class="note-text mb-0 fst-italic">{{ chapter.guodian_text }}</p>
                            </div>
                            {% endif %}
                            <div class="version-explanation">
                                <small class="text-muted">{{ chapter.guodian_diff }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- è‹±æ–‡è¯‘æœ¬ -->
    <section class="english-section mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">å¤šè¯­è¨€è¯‘æœ¬ / Multilingual Translations</h5>
            </div>
            <div class="card-body p-0">
                <ul class="nav nav-pills mb-0 p-2" id="englishTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#lau"
                                type="button">D.C. Lau</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#henricks"
                                type="button">Henricks</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#addiss"
                                type="button">Addiss & Lombardo</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#waley"
                                type="button">Arthur Waley</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#lin"
                                type="button">æ—è¯­å ‚ Lin Yutang</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#mitchell"
                                type="button">Stephen Mitchell</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#japanese"
                                type="button">æ—¥æœ¬èª Japanese</button>
                    </li>
                </ul>
                <div class="tab-content p-3">
                    <div class="tab-pane fade show active" id="lau">
                        <h6 class="text-muted mb-2">D.C. Lau åˆ˜æ®¿çˆµï¼ˆé¦™æ¸¯æ±‰å­¦å®¶ï¼‰</h6>
                        <p class="english-text mb-0 fst-italic">{{ chapter.english_lau }}</p>
                    </div>
                    <div class="tab-pane fade" id="henricks">
                        <h6 class="text-muted mb-2">Robert Henricksï¼ˆé©¬ç‹å †å¸›ä¹¦ç ”ç©¶ä¸“å®¶ï¼‰</h6>
                        <p class="english-text mb-0 fst-italic">{{ chapter.english_henricks }}</p>
                    </div>
                    <div class="tab-pane fade" id="addiss">
                        <h6 class="text-muted mb-2">Addiss & Lombardo</h6>
                        <p class="english-text mb-0 fst-italic">{{ chapter.english_addiss }}</p>
                    </div>
                    <div class="tab-pane fade" id="waley">
                        <h6 class="text-muted mb-2">Arthur Waley äºšç‘ŸÂ·éŸ¦åˆ©ï¼ˆè‹±å›½æ±‰å­¦å®¶ç»å…¸è¯‘æœ¬ï¼‰</h6>
                        <p class="english-text mb-0 fst-italic">{% if chapter.english_waley %}{{ chapter.english_waley }}{% else %}æ­¤ç‰ˆæœ¬æš‚æœªæ”¶å½•{% endif %}</p>
                    </div>
                    <div class="tab-pane fade" id="lin">
                        <h6 class="text-muted mb-2">Lin Yutang æ—è¯­å ‚ï¼ˆä¸­å›½å­¦è€…è‹±è¯‘ï¼‰</h6>
                        <p class="english-text mb-0 fst-italic">{% if chapter.english_lin %}{{ chapter.english_lin }}{% else %}æ­¤ç‰ˆæœ¬æš‚æœªæ”¶å½•{% endif %}</p>
                    </div>
                    <div class="tab-pane fade" id="mitchell">
                        <h6 class="text-muted mb-2">Stephen Mitchellï¼ˆç°ä»£æµè¡Œè¯‘æœ¬ï¼‰</h6>
                        <p class="english-text mb-0 fst-italic">{% if chapter.english_mitchell %}{{ chapter.english_mitchell }}{% else %}æ­¤ç‰ˆæœ¬æš‚æœªæ”¶å½•{% endif %}</p>
                    </div>
                    <div class="tab-pane fade" id="japanese">
                        <h6 class="text-muted mb-2">æ—¥æœ¬èªè¨³ Japanese Translation</h6>
                        <p class="english-text mb-0 fst-italic" lang="ja">{% if chapter.japanese %}{{ chapter.japanese }}{% else %}æ­¤ç‰ˆæœ¬æš‚æœªæ”¶å½•{% endif %}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ç« èŠ‚å¯¼èˆªæŒ‰é’® -->
    <nav class="chapter-navigation" aria-label="ç« èŠ‚ç¿»é¡µ">
        <ul class="pagination justify-content-center">
            {% if chapter.prev_chapter %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('chapter_view', chapter_id=chapter.prev_chapter.chapter) }}">
                    â† ç¬¬{{ chapter.prev_chapter.chapter }}ç« 
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">â† ä¸Šä¸€ç« </span>
            </li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">{{ chapter.chapter }} / {{ chapter.total_chapters }}</span>
            </li>

            {% if chapter.next_chapter %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('chapter_view', chapter_id=chapter.next_chapter.chapter) }}">
                    ç¬¬{{ chapter.next_chapter.chapter }}ç«  â†’
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">ä¸‹ä¸€ç«  â†’</span>
            </li>
            {% endif %}
        </ul>
    </nav>

    <!-- ç¬”è®°æ¨¡æ€æ¡† -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“ é˜…è¯»ç¬”è®° - ç¬¬{{ chapter.chapter }}ç« </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="noteTextarea" class="form-control" rows="6"
                              placeholder="å†™ä¸‹ä½ çš„é˜…è¯»å¿ƒå¾—..."></textarea>
                    <div class="form-text text-muted mt-2">
                        ç¬”è®°ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveNoteBtn">ä¿å­˜ç¬”è®°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•ç”¨å¡ç‰‡æ¨¡æ€æ¡† -->
    <div class="modal fade" id="quoteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“œ å¼•ç”¨å¡ç‰‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="quotePreview" class="mb-3">
                        <canvas id="quoteCanvas" class="img-fluid border rounded"></canvas>
                    </div>
                    <p class="text-muted small">ç”ŸæˆåŒ…å«æœ¬ç« åŸæ–‡çš„ç²¾ç¾å¼•ç”¨å¡ç‰‡</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-success" id="downloadQuoteBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        ä¸‹è½½å›¾ç‰‡
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.original-text {
    font-family: 'KaiTi', 'æ¥·ä½“', serif;
    font-size: clamp(1.5rem, 2.8vw, 2.2rem);
    line-height: 2;
    text-align: center;
    padding: 1.5rem;
}

/* ç–‘éš¾å­—æ ‡æ³¨ - çº¯CSSæ–¹æ¡ˆ */
.difficult {
    border-bottom: 1px dashed var(--accent-color);
    cursor: help;
    position: relative;
    display: inline-block;
    transition: background-color 0.2s;
}

.difficult:hover {
    background-color: rgba(212, 165, 116, 0.15);
}

/* æ‚¬åœæç¤º - æ˜¾ç¤ºåœ¨æ–‡å­—ä¸Šæ–¹ */
.difficult:hover::after {
    content: attr(data-pinyin) ": " attr(data-meaning);
    position: absolute;
    bottom: 130%;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(44, 24, 16, 0.95);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 9999;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    pointer-events: none;
}

/* å°ç®­å¤´ */
.difficult:hover::before {
    content: "";
    position: absolute;
    bottom: 120%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(44, 24, 16, 0.95);
}

[data-theme="dark"] .difficult:hover::after {
    background-color: rgba(232, 224, 216, 0.95);
    color: #2c1810;
}

[data-theme="dark"] .difficult:hover::before {
    border-top-color: rgba(232, 224, 216, 0.95);
}

.modern-text {
    line-height: 1.8;
    font-size: 1.05rem;
}

.note-text {
    line-height: 1.8;
}

.english-text {
    line-height: 1.6;
    font-family: Georgia, serif;
}

.chapter-navigation .page-link {
    border-color: var(--border-color);
}

#versionTabs .nav-link {
    color: var(--text-primary);
    border-color: transparent;
}

#versionTabs .nav-link:hover {
    background-color: rgba(212, 165, 116, 0.1);
}

#versionTabs .nav-link.active {
    color: var(--accent-color);
    border-color: var(--accent-color);
}

#englishTabs .nav-link {
    color: var(--text-primary);
}

#englishTabs .nav-link.active {
    background-color: var(--accent-color);
}

/* ç‰ˆæœ¬æ–‡æ¡£æ ·å¼ */
.version-content {
    line-height: 1.8;
}

.version-original-text {
    padding: 0.75rem;
    background-color: var(--bg-secondary);
    border-left: 3px solid var(--accent-color);
    border-radius: 4px;
}

.version-explanation {
    padding: 0.5rem 0;
}

/* æ“ä½œæŒ‰é’®æ  */
.action-bar {
    background-color: var(--bg-secondary);
    padding: 0.75rem;
    border-radius: 8px;
}

/* æˆè¯­å±•ç¤º */
.idioms-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.idiom-tag {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    color: var(--text-primary);
}

.idiom-tag:hover {
    background-color: var(--accent-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.idiom-tag .idiom-word {
    font-weight: bold;
}

.idiom-tag .idiom-chapter {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-left: 0.5rem;
}

/* æ”¶è—æŒ‰é’®çŠ¶æ€ */
#bookmarkBtn.active svg {
    fill: var(--accent-color);
}

#bookmarkBtn.active {
    color: var(--accent-color);
    border-color: var(--accent-color);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// å½“å‰ç« èŠ‚å·
const CURRENT_CHAPTER = {{ chapter.chapter }};

// ==================== æˆè¯­åŠŸèƒ½ ====================
async function loadIdioms() {
    const container = document.getElementById('idiomsContainer');
    if (!container) return;

    try {
        const response = await fetch('/api/daodejing/idioms');
        const data = await response.json();
        const idioms = data.idioms || [];

        // ç­›é€‰ä¸æœ¬ç« èŠ‚ç›¸å…³çš„æˆè¯­
        const relatedIdioms = idioms.filter(idiom => idiom.chapter === CURRENT_CHAPTER);

        if (relatedIdioms.length === 0) {
            container.innerHTML = '<span class="text-muted">æœ¬ç« æš‚æ— æ”¶å½•ç›¸å…³æˆè¯­</span>';
            return;
        }

        container.innerHTML = relatedIdioms.map(idiom => `
            <a href="/daodejing/chapter/${idiom.chapter}"
               class="idiom-tag"
               title="${idiom.meaning}\nåŸæ–‡ï¼š${idiom.source}">
                <span class="idiom-word">${idiom.word}</span>
                <span class="idiom-chapter">ç¬¬${idiom.chapter}ç« </span>
            </a>
        `).join('');
    } catch (error) {
        console.error('åŠ è½½æˆè¯­å¤±è´¥:', error);
        container.innerHTML = '<span class="text-muted">åŠ è½½å¤±è´¥</span>';
    }
}

// ==================== ä¹¦ç­¾åŠŸèƒ½ ====================
function initBookmarks() {
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    if (!bookmarkBtn) return;

    const BOOKMARKS_KEY = 'daodejing_bookmarks';
    const getBookmarks = () => JSON.parse(localStorage.getItem(BOOKMARKS_KEY) || '[]');
    const isBookmarked = () => getBookmarks().includes(CURRENT_CHAPTER);

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    function updateBookmarkButton() {
        if (isBookmarked()) {
            bookmarkBtn.classList.add('active');
            bookmarkBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2z"></path>
                </svg>
                <span class="ms-1">å·²æ”¶è—</span>
            `;
        } else {
            bookmarkBtn.classList.remove('active');
            bookmarkBtn.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2z"></path>
                </svg>
                <span class="ms-1">æ”¶è—</span>
            `;
        }
    }

    // åˆ‡æ¢æ”¶è—çŠ¶æ€
    bookmarkBtn.addEventListener('click', function() {
        let bookmarks = getBookmarks();
        if (isBookmarked()) {
            bookmarks = bookmarks.filter(id => id !== CURRENT_CHAPTER);
            showToast('å·²å–æ¶ˆæ”¶è—');
        } else {
            bookmarks.push(CURRENT_CHAPTER);
            showToast('å·²æ”¶è—æœ¬ç« ');
        }
        localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks));
        updateBookmarkButton();
    });

    updateBookmarkButton();
}

// ==================== ç¬”è®°åŠŸèƒ½ ====================
function initNotes() {
    const noteBtn = document.getElementById('noteBtn');
    const noteModal = document.getElementById('noteModal');
    const noteTextarea = document.getElementById('noteTextarea');
    const saveNoteBtn = document.getElementById('saveNoteBtn');

    if (!noteBtn || !noteModal) return;

    const NOTES_KEY = 'daodejing_notes';
    const getNotes = () => JSON.parse(localStorage.getItem(NOTES_KEY) || '{}');

    // æ‰“å¼€ç¬”è®°æ¨¡æ€æ¡†
    noteBtn.addEventListener('click', function() {
        const notes = getNotes();
        const chapterNote = notes[CURRENT_CHAPTER] || '';
        noteTextarea.value = chapterNote;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (chapterNote) {
            noteBtn.classList.add('active');
            noteBtn.querySelector('span').textContent = 'ç¼–è¾‘ç¬”è®°';
        } else {
            noteBtn.classList.remove('active');
            noteBtn.querySelector('span').textContent = 'ç¬”è®°';
        }

        const modal = new bootstrap.Modal(noteModal);
        modal.show();
    });

    // ä¿å­˜ç¬”è®°
    saveNoteBtn.addEventListener('click', function() {
        const notes = getNotes();
        notes[CURRENT_CHAPTER] = noteTextarea.value.trim();
        localStorage.setItem(NOTES_KEY, JSON.stringify(notes));

        if (notes[CURRENT_CHAPTER]) {
            noteBtn.classList.add('active');
            noteBtn.querySelector('span').textContent = 'ç¼–è¾‘ç¬”è®°';
            showToast('ç¬”è®°å·²ä¿å­˜');
        } else {
            noteBtn.classList.remove('active');
            noteBtn.querySelector('span').textContent = 'ç¬”è®°';
        }

        const modal = bootstrap.Modal.getInstance(noteModal);
        if (modal) modal.hide();
    });

    // æ£€æŸ¥æ˜¯å¦æœ‰ç¬”è®°
    const notes = getNotes();
    if (notes[CURRENT_CHAPTER]) {
        noteBtn.classList.add('active');
        noteBtn.querySelector('span').textContent = 'ç¼–è¾‘ç¬”è®°';
    }
}

// ==================== å·¥å…·å‡½æ•° ====================
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = '1100';
    toast.innerHTML = `
        <div class="toast show">
            <div class="toast-body">${message}</div>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', function() {
    loadIdioms();
    initBookmarks();
    initNotes();
});

// é”®ç›˜å¯¼èˆª
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        const prevLink = document.querySelector('.chapter-navigation .page-item:first-child a');
        if (prevLink) prevLink.click();
    } else if (e.key === 'ArrowRight') {
        const nextLink = document.querySelector('.chapter-navigation .page-item:last-child a');
        if (nextLink) nextLink.click();
    } else if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('noteModal'));
        if (modal) modal.hide();
    }
});
</script>
{% endblock %}
